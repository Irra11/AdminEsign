<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Irra Esign - Instant Payment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --primary-blue: #0072b5; --primary-cyan: #00bcd4; --bg-color: #f8f9fb; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Hanuman', sans-serif; }
        body { background-color: var(--bg-color); min-height: 100vh; display: flex; flex-direction: column; padding-top: 75px; }
        
        /* Navbar */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 5%; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); z-index: 1000; border-bottom: 1px solid #eee; }
        .nav-logo { font-weight: 800; font-size: 1.4rem; color: var(--primary-blue); position: absolute; left: 50%; transform: translateX(-50%); }
        .btn-udid-nav { background: #fff1f2; color: #e11d48; padding: 10px 18px; border-radius: 50px; text-decoration: none; font-size: 12px; font-weight: 700; }
        
        /* Container */
        .container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .card { background: #fff; width: 100%; max-width: 480px; border-radius: 35px; padding: 40px 30px; box-shadow: 0 15px 45px rgba(0,0,0,0.05); text-align: center; border-top: 8px solid var(--primary-blue); }
        
        /* Product Info */
        .product-icon { width: 90px; height: 90px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; border: 4px solid #fff; box-shadow: 0 10px 25px rgba(0,114,181,0.2); }
        .product-icon img { width: 100%; height: 100%; object-fit: cover; }
        .amount-box { display: flex; justify-content: space-between; align-items: center; background: #f4f7f9; border-radius: 18px; padding: 15px 25px; margin-bottom: 25px; }
        .amount-value { font-size: 28px; font-weight: 800; color: #005a92; }
        
        /* Inputs */
        .input-field { width: 100%; padding: 16px; border-radius: 15px; border: 1.5px solid #edf2f7; margin-bottom: 15px; font-size: 15px; outline: none; }
        .input-field:focus { border-color: var(--primary-blue); }
        
        /* Terminal */
        .terminal { background: #1a202c; border-radius: 15px; padding: 15px; text-align: left; margin-bottom: 25px; color: #cbd5e1; font-family: 'Courier New', monospace; font-size: 12px; }
        
        /* Buttons */
        .btn-pay { width: 100%; background: linear-gradient(to right, #0072b5, #00bcd4); color: #fff; padding: 18px; border: none; border-radius: 15px; font-size: 16px; font-weight: 800; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        .btn-pay.active { opacity: 1; pointer-events: auto; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 3000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .m-card { background: #fff; border-radius: 30px; padding: 30px; width: 100%; max-width: 400px; text-align: center; position: relative; }
        
        .qr-display { width: 100%; border-radius: 15px; border: 1px solid #eee; margin: 15px 0; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Status */
        .status-badge { background: #fff3cd; color: #856404; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="menu-toggle"><i class="fas fa-bars"></i></div>
        <div class="nav-logo">Irra Esign</div>
        <a href="https://udid.tech/" target="_blank" class="btn-udid-nav"><i class="fas fa-play-circle"></i> Get UDID</a>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="card animate__animated animate__fadeInUp">
            <div class="product-icon">
                <img src="https://i.pinimg.com/474x/da/83/78/da8378a6ddba21823631bd644bee4266.jpg" alt="Logo">
            </div>
            
            <h2 class="mb-2">iOS Certificate</h2>
            <p style="color:#718096; margin-bottom:20px; font-size:14px;">P12 & Mobileprovision (1 Year)</p>

            <div class="amount-box">
                <span>Price</span>
                <div><span style="text-decoration:line-through; color:red; margin-right:5px;">$15.00</span> <span class="amount-value">$10.00</span></div>
            </div>

            <!-- Inputs -->
            <input type="text" id="udidInput" class="input-field" placeholder="Paste UDID here..." oninput="checkInputs()">
            <input type="email" id="emailInput" class="input-field" placeholder="Enter your Email" oninput="checkInputs()">

            <!-- Terminal -->
            <div class="terminal">
                <div style="color:#4a5568; font-weight:bold; margin-bottom:5px;">SYSTEM CHECK</div>
                <span style="color:var(--primary-cyan)">>_</span> <span id="udidStatus">Waiting for input...</span>
            </div>

            <label style="display:flex; gap:10px; text-align:left; font-size:13px; color:#555; margin-bottom:20px;">
                <input type="checkbox" id="termsCheck" onchange="checkInputs()"> 
                <span>I confirm this UDID is correct and agree to terms.</span>
            </label>

            <button id="payBtn" class="btn-pay" onclick="generateQR()">Pay Now <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="modal">
        <div class="m-card animate__animated animate__zoomIn">
            <button onclick="closeModal()" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:18px; cursor:pointer;"><i class="fas fa-times"></i></button>
            
            <h3 style="font-family:'Hanuman'">Scan to Pay</h3>
            <p style="color:#777; font-size:14px;">Amount: <b style="color:#0072b5">$10.00</b></p>

            <div id="loading" class="loader"></div>
            <img id="qrImage" class="qr-display" style="display:none;" src="" alt="KHQR">

            <div id="paymentStatus" class="status-badge">Generating QR...</div>
            
            <p style="font-size:12px; color:#999;">Please scan with ABA or Bakong App.<br>Do not close this window.</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="m-card animate__animated animate__tada">
            <i class="fas fa-check-circle" style="font-size:60px; color:#27ae60; margin-bottom:20px;"></i>
            <h3>Payment Successful!</h3>
            <p style="color:#555; font-size:14px; margin-bottom:20px;">Your order has been placed. Please check your email shortly.</p>
            <button class="btn-pay active" onclick="location.reload()">Done</button>
        </div>
    </div>

    <script>
        const API_BASE = ""; // Leave empty if hosted on same domain
        let pollInterval = null;

        function checkInputs() {
            const udid = document.getElementById('udidInput').value;
            const email = document.getElementById('emailInput').value;
            const checked = document.getElementById('termsCheck').checked;
            const btn = document.getElementById('payBtn');
            const term = document.getElementById('udidStatus');

            term.innerText = udid.length > 10 ? "UDID Detected: " + udid.substring(0, 5) + "..." : "Waiting for input...";

            if (udid.length >= 20 && email.includes('@') && checked) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        async function generateQR() {
            document.getElementById('qrModal').classList.add('active');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('qrImage').style.display = 'none';
            document.getElementById('paymentStatus').innerText = "Generating QR...";

            const udid = document.getElementById('udidInput').value;
            const email = document.getElementById('emailInput').value;

            try {
                const res = await fetch(`${API_BASE}/api/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ udid, email })
                });
                const data = await res.json();

                if (data.success) {
                    // Show QR
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('qrImage').src = "data:image/png;base64," + data.qr_image;
                    document.getElementById('qrImage').style.display = 'block';
                    document.getElementById('paymentStatus').innerText = "Waiting for Payment...";
                    
                    // Start Checking
                    startPolling(data.md5);
                } else {
                    alert("Error: " + data.error);
                    closeModal();
                }
            } catch (e) {
                alert("Connection Error");
                closeModal();
            }
        }

        function startPolling(md5) {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/check-payment/${md5}`);
                    const data = await res.json();
                    
                    if (data.status === "PAID") {
                        clearInterval(pollInterval);
                        document.getElementById('qrModal').classList.remove('active');
                        document.getElementById('successModal').classList.add('active');
                    }
                } catch (e) {
                    console.log("Polling error", e);
                }
            }, 2000); // Check every 2 seconds
        }

        function closeModal() {
            document.getElementById('qrModal').classList.remove('active');
            if (pollInterval) clearInterval(pollInterval);
        }
    </script>

</body>
</html>

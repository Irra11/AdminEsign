<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Irra Esign</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root{--primary-blue:#0072b5;--primary-cyan:#00bcd4;--bg-color:#f8f9fb;--text-main:#2d3748;--text-muted:#718096}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter','Hanuman',sans-serif}
        body{background-color:var(--bg-color);background-image:radial-gradient(#d1d5db .8px,transparent .8px);background-size:24px 24px;color:var(--text-main);min-height:100vh;display:flex;flex-direction:column;padding-top:75px}
        
        /* Navbar */
        .navbar{position:fixed;top:0;left:0;right:0;height:70px;display:flex;justify-content:space-between;align-items:center;padding:0 15px;background:rgba(255,255,255,.8);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);z-index:1000;border-bottom:1px solid rgba(0,0,0,.05)}
        .nav-logo{font-weight:800;font-size:1.1rem;color:var(--primary-blue);position:absolute;left:50%;transform:translateX(-50%)}
        .menu-toggle{font-size:20px;color:var(--primary-blue);cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center}
        .btn-udid-nav{background:#fff1f2;color:#e11d48;padding:8px 12px;border-radius:50px;text-decoration:none;font-size:11px;font-weight:700;display:flex;align-items:center;gap:5px;transition:.3s}
        .btn-udid-nav:active{transform:scale(.95)}
        
        /* Side Menu */
        .side-menu{position:fixed;top:0;left:-280px;width:280px;height:100%;background:rgba(255,255,255,.98);backdrop-filter:blur(20px);z-index:2000;transition:.4s cubic-bezier(.4,0,.2,1);box-shadow:10px 0 30px rgba(0,0,0,0.05);padding:30px 20px}
        .side-menu.active{left:0}
        .menu-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);z-index:1999;display:none}
        .menu-overlay.active{display:block}
        .menu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
        .menu-list{border:1px solid #e2e8f0;border-radius:18px;overflow:hidden;background:#fff}
        .menu-item{padding:16px 20px;display:flex;align-items:center;gap:15px;text-decoration:none;color:var(--text-main);font-weight:600;transition:.2s;cursor:pointer;border-bottom:1px solid #f1f5f9}
        .menu-item:last-child{border-bottom:none}
        
        /* Container & Card */
        .container{flex:1;display:flex;justify-content:center;align-items:center;padding:20px}
        .card{background:#fff;width:100%;max-width:480px;border-radius:35px;padding:40px 30px;box-shadow:0 15px 45px rgba(0,0,0,.05);border:1px solid #fff;position:relative;text-align:center}
        .card::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:var(--primary-blue);border-radius:35px 35px 0 0}
        
        /* Product Info */
        .product-icon{width:90px;height:90px;background:linear-gradient(135deg,#0072b5 0%,#00bcd4 100%);border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;border:4px solid #fff;box-shadow:0 10px 25px rgba(0,114,181,.2);overflow:hidden}
        .logo-img{width:100%;height:100%;object-fit:cover}
        .amount-box{display:flex;justify-content:space-between;align-items:center;background:#f4f7f9;border-radius:18px;padding:15px 25px;border:1px solid #edf2f7;margin-bottom:25px}
        .old-price{text-decoration:line-through;color:#ff2d0c;font-size:16px;margin-right:8px}
        .amount-value{font-size:28px;font-weight:800;color:#005a92}
        
        /* Inputs & Terminal */
        .input-field{width:100%;padding:16px 15px 16px 45px;border-radius:15px;border:1.5px solid #edf2f7;outline:0;transition:.3s;font-size:15px}
        .terminal{background:#1a202c;border-radius:15px;padding:15px;text-align:left;margin-bottom:25px}
        .btn-get-udid{display:flex;align-items:center;justify-content:center;gap:10px;background:#f1f5f9;color:var(--primary-blue);text-decoration:none;padding:12px;border-radius:12px;font-size:13px;font-weight:700;margin-bottom:25px;border:1px dashed var(--primary-blue);transition:.3s}
        .terms-box{display:flex;gap:12px;align-items:flex-start;text-align:left;font-size:13px;color:#718096;margin-bottom:30px;cursor:pointer}
        
        /* Pay Button */
        .btn-pay{width:100%;background:linear-gradient(to right,#0072b5,#00bcd4);color:#fff;padding:18px;border:none;border-radius:15px;font-size:16px;font-weight:800;cursor:pointer;opacity:.3;pointer-events:none;transition:0.3s}
        .btn-pay.active{opacity:1;pointer-events:auto}
        
        /* Modals */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);z-index:3000;justify-content:center;align-items:center;padding:20px}
        .modal.active{display:flex}
        .m-card{background:#fff;border-radius:30px;padding:35px;width:100%;max-width:420px;text-align:center;position:relative}
        
        /* QR Specifics */
        .qr-img{width:100%;border-radius:20px;margin-bottom:20px;border:1px solid #eee; display:none;}
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0072b5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-badge { background: #fff3cd; color: #856404; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; display: inline-block; margin-bottom: 15px; }

        /* Footer */
        .footer{padding:40px 20px;text-align:center;color:var(--text-muted);font-size:13px;margin-top:auto}
        .footer-links{margin-top:10px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap}
        .footer-links a{color:var(--text-muted);text-decoration:none;transition:.3s;font-size:12px}
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <div class="menu-toggle" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
    <div class="nav-logo">Irra Esign</div>
    <a href="https://t.me/Irra_Esign/3" class="btn-udid-nav"><i class="fas fa-play-circle"></i> របៀបយក UDID</a>
</nav>

<!-- Side Menu -->
<div class="menu-overlay" id="menuOverlay" onclick="toggleMenu(false)"></div>
<div class="side-menu" id="sideMenu">
    <div class="menu-header">
        <h4 class="fw-bold">Menu</h4>
        <i class="fas fa-times" onclick="toggleMenu(false)" style="font-size:20px;color:#888;cursor:pointer"></i>
    </div>
    <div class="menu-list">
        <a href="https://t.me/Irra_Esign/3" class="menu-item"><i class="fas fa-play-circle" style="color:#e11d48"></i> <span>របៀបយក UDID</span></a> 
        <a href="https://t.me/irra_11" class="menu-item"><i class="fab fa-telegram-plane" style="color:#0088cc"></i> <span>ទាក់ទង Admin</span></a>
        <div class="menu-item" onclick="showAbout()"><i class="fas fa-info-circle" style="color:#64748b"></i> <span>អំពីយើង (About)</span></div>
    </div>
</div>

<!-- Main Card -->
<div class="container">
    <div class="card animate__animated animate__fadeInUp">
        <div class="product-icon"><img src="https://i.pinimg.com/474x/da/83/78/da8378a6ddba21823631bd644bee4266.jpg" alt="Logo" class="logo-img"></div>
        <h2 class="title">Certificate</h2>
        <p class="subtitle">P12 & Mobileprovision for iOS</p>
        
        <div class="features" style="margin-bottom:25px;font-size:13px;text-align:left;color:#555;border:1.5px solid #edf2f7;padding:18px;border-radius:20px;background-color:#fafbfc">
            <div style="margin-bottom:10px"><i class="fas fa-check-circle" style="color:var(--primary-blue);margin-right:8px"></i> Valid for 1 Year (365 Days)</div>
            <div style="margin-bottom:10px"><i class="fas fa-shield-alt" style="color:var(--primary-blue);margin-right:8px"></i> 30 Days Revoke Warranty</div>
            <div style="margin-bottom:0"><i class="fas fa-bolt" style="color:var(--primary-blue);margin-right:8px"></i> Instant Delivery via Email</div>
        </div>

        <div class="amount-box">
            <span class="amount-label" style="font-family:'Hanuman'">តម្លៃ</span>
            <div><span class="old-price">$15.00</span> <span class="amount-value">$10.00</span></div>
        </div>

        <!-- Input Section -->
        <div style="text-align:left;margin-bottom:20px">
            <label style="font-size:12px;font-weight:700;color:#4a5568;margin-bottom:8px;display:block">DEVICE UDID</label>
            <div style="position:relative">
                <i class="fas fa-mobile-screen-button" style="position:absolute;left:18px;top:18px;color:#a0aec0"></i> 
                <input type="text" id="udidInput" class="input-field" placeholder="Paste UDID here..." oninput="updateUDID(this.value)">
            </div>
        </div>

        <div class="terminal">
            <span style="font-size:8px;color:#4a5568;font-weight:700;letter-spacing:1px">DETECTED UDID</span>
            <div style="color:#cbd5e1;font-family:'Courier New';font-size:12.5px;margin-top:5px">
                <span style="color:var(--primary-cyan);font-weight:700">>_</span> <span id="udidStatus">Waiting for input...</span>
            </div>
        </div>

        <a href="https://udid.tech/" target="_blank" class="btn-get-udid"><i class="fas fa-fingerprint"></i> ចុចទីនេះដើម្បីយក UDID</a>

        <label class="terms-box">
            <input type="checkbox" id="termsCheck" onchange="validateForm()" style="width:22px;height:22px;margin-top:2px"> 
            <span>ខ្ញុំសូមបញ្ជាក់ថា UDID នេះពិតជាត្រឹមត្រូវ និងយល់ព្រមតាមលក្ខខណ្ឌ។</span>
        </label> 

        <button id="payBtn" class="btn-pay" onclick="document.getElementById('emailModal').classList.add('active')">Next <i class="fas fa-arrow-right"></i></button>
    </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="modal">
    <div class="m-card animate__animated animate__zoomIn">
        <i class="fas fa-envelope-open-text" style="font-size:50px;color:var(--primary-blue);margin-bottom:20px"></i>
        <h4 class="fw-bold" style="font-family:'Hanuman'">អ៊ីមែលរបស់អ្នក</h4>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:25px">សម្រាប់ទទួល File Certificate</p>
        <div style="position:relative;text-align:left">
            <i class="fas fa-at" style="position:absolute;left:15px;top:18px;color:#a0aec0"></i> 
            <input type="email" id="emailInput" class="input-field" placeholder="example@gmail.com" style="margin-bottom:20px;padding-left:45px;width:100%;border-radius:15px">
        </div>
        <button class="btn-pay active" style="opacity:1;pointer-events:auto;width:100%;border-radius:15px;font-family:'Hanuman'" onclick="validateEmail()">បន្តទៅកាន់ការបង់ប្រាក់ <i class="fas fa-arrow-right ms-2"></i></button>
    </div>
</div>

<!-- QR Payment Modal -->
<div id="qrModal" class="modal">
    <div class="m-card animate__animated animate__zoomIn" style="position:relative;padding:35px 25px">
        <button onclick="closeAllModals()" style="position:absolute;top:15px;right:15px;border:none;background:#f9f1f1;color:#b41d17;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;z-index:10;transition:.3s"><i class="fas fa-times"></i></button>
        
        <h4 class="fw-bold mb-2" style="font-family:'Hanuman'">ស្កេនដើម្បីបង់ប្រាក់</h4>
        <p style="font-size:14px;color:var(--text-muted);margin-bottom:20px">តម្លៃសរុប: <b style="color:var(--primary-blue);font-size:20px">$10.00</b></p>
        
        <!-- Loading Spinner -->
        <div id="qrLoading" class="loader"></div>
        
        <!-- QR Image -->
        <img id="qrImage" class="qr-img" src="" style="display:none;">
        
        <!-- Status Box / Manual Button -->
        <div id="paymentStatus" class="status-badge">Generating KHQR...</div>
        
        <p style="font-size:12px;color:#999;margin-top:15px;">
            សូមស្កេនជាមួយ ABA ឬ Bakong App.<br>
            ប្រព័ន្ធនឹងត្រួតពិនិត្យដោយស្វ័យប្រវត្តិ។
        </p>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal">
    <div class="m-card animate__animated animate__tada">
        <i class="fas fa-check-circle" style="font-size:60px; color:#27ae60; margin-bottom:20px;"></i>
        <h3 style="font-family:'Hanuman'">ការបង់ប្រាក់ជោគជ័យ!</h3>
        <p style="color:#555; font-size:14px; margin-bottom:20px;">ការកុម្ម៉ង់របស់អ្នកត្រូវបានទទួល។ សូមពិនិត្យអ៊ីមែលរបស់អ្នកក្នុងពេលបន្តិចទៀតនេះ។</p>
        <button class="btn-pay active" onclick="location.reload()" style="opacity:1;pointer-events:auto;width:100%;border-radius:15px">រួចរាល់ (Done)</button>
    </div>
</div>

<!-- About Modal -->
<div id="aboutModal" class="modal">
    <div class="m-card animate__animated animate__zoomIn" style="max-width:450px">
        <h4 class="fw-bold mb-3" style="color:var(--primary-blue)">Irra Esign Store</h4>
        <div style="font-size:14px;color:var(--text-muted);line-height:1.8;text-align:left">
            <p><b>កម្មវិធី E-Sign</b> គឺជា utility app ដែលមានប្រយោជន៍សម្រាប់ (sign) ឯកសារ IPA ដោយផ្ទាល់លើឧបករណ៍ iOS ដូចជា iPhone ឬ iPad ដោយមិនចាំបាច់ប្រើកុំព្យូទ័រ។</p>
            <hr style="border:0;border-top:1px solid #f1f5f9;margin:15px 0">
            <p>យើងខ្ញុំផ្ដល់ជូនសេវាកម្ម iOS Certificate (P12 & Mobileprovision) ដែលមានគុណភាពខ្ពស់ ធានាសុវត្ថិភាព និងការប្រើប្រាស់បានយូរអង្វែង។</p>
        </div>
        <button class="btn-pay active" style="margin-top:25px;opacity:1;pointer-events:auto;width:100%;border-radius:15px" onclick="document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'))">យល់ព្រម</button>
    </div>
</div>

<footer class="footer animate__animated animate__fadeIn">
    <p>© 2026 <b>Irra Esign</b>. All rights reserved</p>
    <div class="footer-links"><a href="#">Terms of Service</a> <span>|</span> <a href="#">Privacy Policy</a> <span>|</span> <a href="https://t.me/irra_11">Support</a></div>
</footer>

<script>
    // ==========================================
    // 1. CONFIGURATION
    // ==========================================
    const API_BASE = "https://adminesign.onrender.com"; // Your Render URL
    let pollInterval = null;
    let paymentTimeout = null;
    let currentOrderId = null;

    // ==========================================
    // 2. UI FUNCTIONS
    // ==========================================
    function toggleMenu(show) {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('menuOverlay');
        if (show) { menu.classList.add('active'); overlay.classList.add('active'); } 
        else { menu.classList.remove('active'); overlay.classList.remove('active'); }
    }

    function showAbout() {
        toggleMenu(false);
        document.getElementById('aboutModal').classList.add('active');
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        if (pollInterval) clearInterval(pollInterval);
        if (paymentTimeout) clearTimeout(paymentTimeout);
    }

    function updateUDID(val) {
        val = val.trim();
        document.getElementById('udidInput').value = val;
        const status = document.getElementById('udidStatus');
        if (val.length > 10) { status.innerText = val; status.style.color = "#00bcd4"; } 
        else { status.innerText = "Waiting for input..."; status.style.color = "#64748b"; }
        validateForm();
    }

    function validateForm() {
        const udid = document.getElementById('udidInput').value;
        const checked = document.getElementById('termsCheck').checked;
        const btn = document.getElementById('payBtn');
        if (udid.length >= 20 && checked) btn.classList.add('active');
        else btn.classList.remove('active');
    }

    function validateEmail() {
        const email = document.getElementById('emailInput').value;
        if (!email.includes('@')) {
            alert("សូមបញ្ចូលអ៊ីមែលឱ្យបានត្រឹមត្រូវ!");
            return;
        }
        document.getElementById('emailModal').classList.remove('active');
        generateQR();
    }

    // ==========================================
    // 3. PAYMENT LOGIC
    // ==========================================
    async function generateQR() {
        document.getElementById('qrModal').classList.add('active');
        document.getElementById('qrLoading').style.display = 'block';
        document.getElementById('qrImage').style.display = 'none';
        
        const statusBox = document.getElementById('paymentStatus');
        statusBox.innerHTML = "Generating KHQR...";
        statusBox.className = "status-badge";
        statusBox.style.background = "#fff3cd";

        const udid = document.getElementById('udidInput').value;
        const email = document.getElementById('emailInput').value;

        try {
            const response = await fetch(`${API_BASE}/api/create-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ udid: udid, email: email })
            });
            const data = await response.json();

            if (data.success) {
                // Save Order info
                window.currentOrderId = data.order_id;
                
                // Show QR
                document.getElementById('qrLoading').style.display = 'none';
                document.getElementById('qrImage').src = "data:image/png;base64," + data.qr_image;
                document.getElementById('qrImage').style.display = 'block';
                
                statusBox.innerHTML = "Waiting for Payment...";
                statusBox.style.backgroundColor = "#e0f7fa";
                statusBox.style.color = "#006064";

                // Start Auto Check (Using MD5)
                startPolling(data.md5);

                // Fallback Timer (30 seconds)
                if(paymentTimeout) clearTimeout(paymentTimeout);
                paymentTimeout = setTimeout(enableManualButton, 30000);

            } else {
                alert("Error: " + (data.error || "Unknown"));
                closeAllModals();
            }
        } catch (e) {
            alert("Connection Failed");
            closeAllModals();
        }
    }

    // CHECK PAYMENT STATUS (Using MD5)
    function startPolling(md5) {
        if (pollInterval) clearInterval(pollInterval);
        
        pollInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/api/check-payment/${md5}`);
                const data = await res.json();
                
                if (data.status === "PAID") {
                    clearInterval(pollInterval);
                    if(paymentTimeout) clearTimeout(paymentTimeout);
                    showSuccess();
                }
            } catch (e) {
                console.log("Polling...");
            }
        }, 2500); 
    }

    // SHOW MANUAL BUTTON (Fallback)
    function enableManualButton() {
        const statusBox = document.getElementById('paymentStatus');
        statusBox.style.background = "transparent";
        statusBox.innerHTML = `
            <div style="display:flex; flex-direction:column; gap:10px; animation: fadeIn 0.5s;">
                <span style="color:#e74c3c; font-size:12px;">Auto-detect is taking long...</span>
                <button onclick="manualConfirm()" class="btn-pay active" style="font-size:13px; padding:10px; background:#27ae60; opacity:1; pointer-events:auto; border-radius:10px;">
                    <i class="fas fa-check-circle"></i> ខ្ញុំបានបង់ប្រាក់រួចរាល់ (I Have Paid)
                </button>
            </div>
        `;
    }

    async function manualConfirm() {
        if (!window.currentOrderId) return;
        
        const btn = document.querySelector('#paymentStatus button');
        if(btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;
        }

        try {
            await fetch(`${API_BASE}/api/confirm-manual`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: window.currentOrderId })
            });
            clearInterval(pollInterval);
            showSuccess(true);
        } catch (e) {
            showSuccess(true);
        }
    }

    function showSuccess(isManual = false) {
        document.getElementById('qrModal').classList.remove('active');
        const successModal = document.getElementById('successModal');
        
        if (isManual) {
            successModal.querySelector('h3').innerText = "សំណើត្រូវបានទទួល (Received)";
            successModal.querySelector('p').innerText = "សូមរង់ចាំ Admin ត្រួតពិនិត្យការបង់ប្រាក់។ Certificate នឹងផ្ញើទៅអ៊ីមែលរបស់អ្នកឆាប់ៗនេះ។";
            successModal.querySelector('i').className = "fas fa-clock";
            successModal.querySelector('i').style.color = "#f39c12";
        }
        
        successModal.classList.add('active');  
    }

    // Security
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false;
        if(e.ctrlKey && (e.shiftKey || e.keyCode == 85)) return false;
    };
</script>

</body>
</html>

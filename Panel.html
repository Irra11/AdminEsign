<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Irra Admin | Dashboard</title>

    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --sidebar-bg: #1a1c2e;
            --main-bg: #f4f7fe;
            --primary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.03);
        }

        body { background: var(--main-bg); font-family: 'Inter', 'Hanuman', sans-serif; margin: 0; overflow-x: hidden; }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 260px; height: 100vh; background: var(--sidebar-bg);
            position: fixed; left: 0; top: 0; color: white; padding: 30px 20px;
            display: flex; flex-direction: column; z-index: 2000;
            transition: all 0.3s ease;
        }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none; backdrop-filter: blur(4px); }
        .admin-profile { text-align: center; margin-bottom: 40px; }
        .admin-profile img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 12px; }
        .nav-link-custom { color: #a3aed0; padding: 12px 18px; border-radius: 12px; display: flex; align-items: center; gap: 15px; text-decoration: none; margin-bottom: 5px; transition: 0.3s; font-size: 14px; }
        .nav-link-custom.active { background: var(--primary); color: white; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2); }
        .logout-btn { margin-top: auto; color: #ff5e5e; cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 15px; font-size: 14px; text-decoration: none; }

        /* --- Content Layout --- */
        .main-content { margin-left: 260px; padding: 25px; min-height: 100vh; transition: all 0.3s ease; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .mobile-menu-btn { display: none; width: 42px; height: 42px; background: white; border: none; border-radius: 10px; color: var(--primary); box-shadow: var(--card-shadow); }

        /* --- Stats Card --- */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 18px; border-radius: 18px; box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .stat-info h3 { font-size: 18px; font-weight: 800; margin: 0; color: #2b3674; }
        .stat-info p { font-size: 11px; color: #a3aed0; margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Table Styling --- */
        .order-card { background: white; border-radius: 22px; padding: 20px; box-shadow: var(--card-shadow); }
        .card-header-custom { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        
        .search-box { position: relative; flex: 1; min-width: 250px; }
        .search-box input { width: 100%; padding: 12px 15px 12px 45px; border-radius: 50px; border: 1px solid #f0f0f0; background: #f4f7fe; font-size: 14px; outline: none; transition: 0.3s; }
        .search-box input:focus { border-color: var(--primary); background: white; }
        .search-box i { position: absolute; left: 18px; top: 15px; color: #a3aed0; }

        .table thead th { border: none; color: #a3aed0; font-size: 11px; font-weight: 700; text-transform: uppercase; padding: 15px; }
        .table tbody td { border-bottom: 1px solid #f8f9fa; padding: 15px; vertical-align: middle; color: #2b3674; font-size: 13px; }
        
        /* Full Gmail Style */
        .gmail-text { font-weight: 700; color: #2b3674; font-size: 13px; display: block; word-break: break-all; margin-bottom: 2px; }
        .time-text { font-size: 10px; color: #a3aed0; display: block; margin-bottom: 5px; }

        /* Copyable UDID Badge */
        .udid-badge {
            font-family: 'Courier New', monospace; font-size: 11px; background: #f0f2ff; color: var(--primary);
            padding: 4px 10px; border-radius: 8px; cursor: pointer; border: 1px dashed #c7cdff;
            display: inline-flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .udid-badge:active { transform: scale(0.95); background: #e0e4ff; }

        .status-badge { padding: 5px 12px; border-radius: 50px; font-size: 10px; font-weight: 700; }
        .status-completed { background: #e6fcf5; color: #0ca678; }
        .status-pending { background: #fff9db; color: #f08c00; }
        
        .btn-action-round { width: 32px; height: 32px; border-radius: 9px; border: none; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; color: white; margin: 2px; }

        /* --- iPhone Responsive --- */
        @media (max-width: 768px) {
            .sidebar { left: -260px; }
            .sidebar.mobile-active { left: 0; }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-menu-btn { display: block; }
            .stat-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { flex-direction: column; text-align: center; padding: 15px 10px; }
            .table thead th:nth-child(2), .table tbody td:nth-child(2) { display: none; }
        }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7fe; display: flex; justify-content: center; align-items: center; z-index: 10001; }
        .status-failed {
    background: #fdedec;
    color: #e74c3c;
}
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>

<!-- Login Overlay -->
<div id="loginOverlay">
    <div class="login-card animate__animated animate__zoomIn" style="background:white; padding:35px; border-radius:25px; box-shadow:0 15px 40px rgba(0,0,0,0.05); text-align:center; width:320px;">
        <img src="https://i.pinimg.com/736x/93/1a/b7/931ab7b0393dab7b07fedb2b22b70a89.jpg" width="70" style="border-radius:50%; border:3px solid var(--primary); margin-bottom:20px;">
        <h5 class="fw-bold">IRRA ADMIN</h5>
        <input type="password" id="adminPassInput" class="form-control mb-3 text-center" placeholder="Password" style="border-radius:10px;">
        <button onclick="handleLogin()" class="btn btn-primary w-100 py-2 fw-bold" style="border-radius:10px; background:var(--primary); border:none;">Login</button>
    </div>
</div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="admin-profile">
        <button class="d-md-none position-absolute end-0 top-0 border-0 bg-transparent text-white p-2" onclick="toggleSidebar(false)"><i class="fas fa-times"></i></button>
        <img src="https://i.pinimg.com/736x/93/1a/b7/931ab7b0393dab7b07fedb2b22b70a89.jpg" alt="Admin">
        <h6 class="mt-2">Irra Admin</h6>
        <div class="online-badge"><div class="online-dot"></div> Online</div>
    </div>
    <nav>
        <a href="#" class="nav-link-custom active"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a>
        <a href="#" class="nav-link-custom"><i class="fas fa-users"></i> <span>Customers</span></a>
    </nav>
    <div class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></div>
</aside>

<!-- Dashboard Content -->
<main class="main-content" id="mainDashboard" style="display:none;">
    <div class="top-nav">
        <div class="d-flex align-items-center gap-3">
            <button class="mobile-menu-btn" onclick="toggleSidebar(true)"><i class="fas fa-bars"></i></button>
            <h4 class="m-0">Order Management</h4>
        </div>
        <button onclick="fetchOrders()" class="btn bg-white rounded-3 shadow-sm text-primary py-2 px-3 border-0"><i class="fas fa-sync-alt"></i></button>
    </div>

    <!-- Stats -->
    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background:#f4f7fe; color:var(--primary);"><i class="fas fa-shopping-bag"></i></div>
            <div class="stat-info"><p>Orders</p><h3 id="statTotal">0</h3></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#e6fcf5; color:var(--success);"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info"><p>Done</p><h3 id="statCompleted">0</h3></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#fff9db; color:var(--warning);"><i class="fas fa-clock"></i></div>
            <div class="stat-info"><p>Pending</p><h3 id="statPending">0</h3></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#eef2ff; color:#4338ca;"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-info"><p>Revenue</p><h3 id="statRevenue">$0</h3></div>
        </div>
    </div>

    <!-- Table -->
    <div class="order-card">
        <div class="card-header-custom">
            <h5 class="fw-bold m-0">Recent Activity</h5>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search by Gmail or UDID..." onkeyup="filterOrders()">
            </div>
        </div>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Gmail & UDID</th>
                        <th class="d-md-table-cell d-none">UDID (Full)</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="orderList"></tbody>
            </table>
        </div>
    </div>
</main>

<!-- Custom Modal -->
<div id="customModal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(5px);">
    <div class="modal-content-custom animate__animated animate__zoomIn" style="background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center;">
        <div id="modalIcon" style="font-size:30px; margin-bottom:15px;"></div>
        <h5 id="modalTitle" class="fw-bold mb-2"></h5>
        <p id="modalBody" class="text-muted small mb-4"></p>
        <div id="inputContainer" style="display:none; text-align:left;">
            <label class="small fw-bold mb-1">DOWNLOAD LINK</label>
            <input type="text" id="modalInput" class="form-control mb-3" style="border-radius:10px;">
        </div>
        <div id="editContainer" style="display:none; text-align:left;"
            <label class="small fw-bold mb-1">GMAIL</label>
            <input type="text" id="editEmail" class="form-control mb-2" style="border-radius:10px;">
            <label class="small fw-bold mb-1">UDID</label>
            <input type="text" id="editUdid" class="form-control mb-3" style="border-radius:10px;">
        </div>
        <div class="d-flex gap-2">
            <button onclick="closeCustomModal()" class="btn btn-light w-100 py-2 fw-bold" style="border-radius:10px;">Cancel</button>
            <button id="modalConfirmBtn" class="btn btn-primary w-100 py-2 fw-bold" style="border-radius:10px; border:none; background: var(--primary);">Confirm</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = "https://api-udid.onrender.com";
let allOrders = [];

// --- ១. មុខងារជំនួយ (Helpers) ---
function getStoredPass() {
    return sessionStorage.getItem('admin_password');
}

function toggleSidebar(show) {
    document.getElementById('sidebar').classList.toggle('mobile-active', show);
    document.getElementById('sidebarOverlay').classList.toggle('active', show);
}

function copyUDID(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("UDID Copied to Clipboard!");
    });
}

function logout() {
    sessionStorage.removeItem('admin_password');
    location.reload();
}

// --- ២. ការពារសុវត្ថិភាព និង Login ---
async function handleLogin() {
    const password = document.getElementById('adminPassInput').value;
    try {
        const res = await fetch(`${API_BASE}/api/admin/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });
        if (res.ok) {
            sessionStorage.setItem('admin_password', password);
            checkAuthStatus();
        } else {
            alert("លេខសម្ងាត់មិនត្រឹមត្រូវ!");
        }
    } catch (err) {
        alert("មិនអាចតភ្ជាប់ទៅ Server បានទេ!");
    }
}

function checkAuthStatus() {
    if (getStoredPass()) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainDashboard').style.display = 'block';
        fetchOrders();
        setInterval(fetchOrders, 30000);
    }
}

// --- ៣. ការគ្រប់គ្រងទិន្នន័យ (Fetching & Stats) ---
async function fetchOrders() {
    const password = getStoredPass();
    if (!password) return;
    try {
        const res = await fetch(`${API_BASE}/api/orders`, {
            headers: { 'x-admin-password': password }
        });
        if (res.status === 401) return logout();
        allOrders = await res.json();
        updateStats();
        displayOrders(allOrders);
    } catch (err) {
        console.error("Fetch error:", err);
    }
}

function updateStats() {
    const total = allOrders.length;
    const completed = allOrders.filter(o => o.status === 'completed').length;
    const failed = allOrders.filter(o => o.status === 'failed').length;
    const revenue = allOrders.reduce((sum, o) => sum + parseFloat(o.price || 0), 0);

    if (document.getElementById('statTotal')) document.getElementById('statTotal').innerText = total;
    if (document.getElementById('statCompleted')) document.getElementById('statCompleted').innerText = completed;
    if (document.getElementById('statPending')) document.getElementById('statPending').innerText = total - (completed + failed);
    if (document.getElementById('statRevenue')) document.getElementById('statRevenue').innerText = `$${revenue.toFixed(2)}`;
}

// --- ៤. ការបង្ហាញទិន្នន័យ និងស្វែងរក ---
function displayOrders(data) {
    const list = document.getElementById('orderList');
    list.innerHTML = '';

    data.forEach(o => {
        let statusClass = 'status-pending';
        if (o.status === 'completed') statusClass = 'status-completed';
        else if (o.status === 'failed') statusClass = 'status-failed';

        list.innerHTML += `
        <tr class="animate__animated animate__fadeIn">
            <td>
                <span class="gmail-text">${o.email}</span>
                <span class="time-text"><i class="far fa-clock"></i> ${o.timestamp || 'N/A'}</span>
                <div class="udid-badge" onclick="copyUDID('${o.udid}')" title="Click to copy full UDID">
                    <i class="far fa-copy"></i> ${o.udid.substring(0, 16)}...
                </div>
            </td>
            <td class="d-md-table-cell d-none"><code style="font-size:11px;">${o.udid}</code></td>
            <td class="fw-bold">$${o.price || '10.00'}</td>
            <td><span class="status-badge ${statusClass}">${o.status.toUpperCase()}</span></td>
            <td class="text-end">
                <div class="d-flex justify-content-end gap-1">
                    <button onclick="approveOrder('${o.order_id}', '${o.email}')" class="btn-action-round bg-success" title="Approve & Send Link"><i class="fas fa-check"></i></button>
                    <button onclick="rejectOrder('${o.order_id}', '${o.email}')" class="btn-action-round bg-danger" title="Reject Order"><i class="fas fa-times"></i></button>
                    <button onclick="editOrder('${o.order_id}', '${o.email}', '${o.udid}', '${o.download_link || ''}')" class="btn-action-round bg-primary" title="Edit Info"><i class="fas fa-edit"></i></button>
                    <button onclick="window.open('${API_BASE + o.receipt_url}', '_blank')" class="btn-action-round bg-info" title="View Receipt"><i class="fas fa-eye"></i></button>
                    <button onclick="deleteOrder('${o.order_id}')" class="btn-action-round bg-secondary" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        </tr>`;
    });
}

function filterOrders() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allOrders.filter(o =>
        o.email.toLowerCase().includes(term) ||
        o.udid.toLowerCase().includes(term)
    );
    displayOrders(filtered);
}

// --- ៥. សកម្មភាព (Approve, Reject, Edit, Delete) ---
async function approveOrder(oid, email) {
    const link = await showModal({
        title: "បញ្ចប់ការបញ្ជាទិញ",
        body: `បញ្ចូល Link វិញ្ញាបនបត្រសម្រាប់ផ្ញើទៅ: ${email}`,
        icon: '<i class="fas fa-check-circle text-success"></i>',
        mode: 'input',
        confirmColor: '#27ae60'
    });

    if (link) {
        const pass = getStoredPass();
        const res = await fetch(`${API_BASE}/api/send-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-admin-password': pass },
            body: JSON.stringify({ order_id: oid, link: link, type: 'success' })
        });
        if (res.ok) { alert("អ៊ីមែលជោគជ័យត្រូវបានផ្ញើ!"); fetchOrders(); }
    }
}

async function rejectOrder(oid, email) {
    const ok = await showModal({
        title: "បដិសេធការបញ្ជាទិញ",
        body: `តើអ្នកច្បាស់ទេថានឹងផ្ញើសារ 'បដិសេធ' ទៅកាន់: ${email}?`,
        icon: '<i class="fas fa-times-circle text-danger"></i>',
        mode: 'confirm',
        confirmColor: '#e74c3c'
    });

    if (ok === true) {
        const pass = getStoredPass();
        const res = await fetch(`${API_BASE}/api/send-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-admin-password': pass },
            body: JSON.stringify({ order_id: oid, type: 'failed' })
        });
        if (res.ok) { alert("អ៊ីមែលបដិសេធត្រូវបានផ្ញើ!"); fetchOrders(); }
    }
}

async function editOrder(oid, email, udid, link) {
    document.getElementById('editEmail').value = email;
    document.getElementById('editUdid').value = udid;
    document.getElementById('modalInput').value = link;

    const result = await showModal({
        title: "កែប្រែព័ត៌មាន",
        body: `Order ID: ${oid}`,
        icon: '<i class="fas fa-edit text-primary"></i>',
        mode: 'edit',
        confirmColor: '#6366f1'
    });

    if (result) {
        const pass = getStoredPass();
        await fetch(`${API_BASE}/api/update-order`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-admin-password': pass },
            body: JSON.stringify({
                order_id: oid,
                email: document.getElementById('editEmail').value,
                udid: document.getElementById('editUdid').value,
                link: document.getElementById('modalInput').value
            })
        });
        fetchOrders();
    }
}

async function deleteOrder(oid) {
    if (!confirm("តើអ្នកច្បាស់ទេថានឹងលុបការបញ្ជាទិញនេះ?")) return;
    const pass = getStoredPass();
    try {
        await fetch(`${API_BASE}/api/delete-order/${oid}`, {
            method: 'DELETE',
            headers: { 'x-admin-password': pass }
        });
        fetchOrders();
    } catch (err) { console.error(err); }
}

// --- ៦. មុខងារបញ្ជា Modal (Merged & Fixed) ---
function showModal({ title, body, icon, mode, confirmColor }) {
    return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const confirmBtn = document.getElementById('modalConfirmBtn');

        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerText = body;
        document.getElementById('modalIcon').innerHTML = icon;

        confirmBtn.style.backgroundColor = confirmColor || '#6366f1';

        // រៀបចំការបង្ហាញ Containers
        document.getElementById('inputContainer').style.display = (mode === 'input' || mode === 'edit') ? 'block' : 'none';
        document.getElementById('editContainer').style.display = (mode === 'edit') ? 'block' : 'none';

        if (mode === 'input') document.getElementById('modalInput').value = "";

        modal.style.display = 'flex';

        confirmBtn.onclick = () => {
            let result = true;
            if (mode === 'input') {
                result = document.getElementById('modalInput').value.trim();
                if (!result) return alert("សូមបញ្ចូល Link!");
            } else if (mode === 'edit') {
                result = true; // យកតម្លៃពី Input fields ផ្ទាល់ក្នុង editOrder
            }
            modal.style.display = 'none';
            resolve(result);
        };
    });
}

function closeCustomModal() {
    document.getElementById('customModal').style.display = 'none';
}

// ចាប់ផ្ដើមដំណើរការ
window.onload = checkAuthStatus;
</script>
</body>
</html>
